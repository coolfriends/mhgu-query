#!/usr/bin/env ruby
# coding: utf-8
require 'open-uri'
require 'nokogiri'
require 'pry'

human_readable = {
  'greatsword' => 'Greatsword',
  'longsword' => 'Longsword',
  'sword' => 'Sword & Shield',
  'dualblades' => 'Dual Blades',
  'hammer' => 'Hammer',
  'huntinghorn' => 'Hunting Horn',
  'lance' => 'Lance',
  'gunlance' => 'Gunlance',
  'switchaxe' => 'Switch Axe',
  'chargeblade' => 'Charge Blade',
  'insectglaive' => 'Insect Glaive',
  'bow' => 'Bow',
  'lightbowgun' => 'Light Bowgun',
  'heavybowgun' => 'Heavy Bowgun',
}.freeze

weapon_names = [
  'greatsword',
  'longsword',
  'sword',
  'dualblades',
  'hammer',
  'huntinghorn',
  'lance',
  'gunlance',
  'switchaxe',
  'chargeblade',
  'insectglaive',
  'bow',
  'lightbowgun',
  'heavybowgun',
].freeze

# Used to get the initial list of Kiranico specific weapon names.
# This isn't really needed anymore.
def weapon_names_from_kiranico
  doc = Nokogiri::HTML(open("https://mhgu.kiranico.com/"))
  weapons_xpath = '/html/body/div[1]/div[2]/div[1]/div[2]/div/div/div/div[1]/table[2]'
  weapon_elements = doc.search(weapons_xpath).first.css("a")
  weapon_elements.map do |e|
    e[:href].split('/').last
  end
end

# Collect data for every weapon type, e.g. https://mhgu.kirancio.com/greatsword
weapon_names.each do |name|
  puts "Collecting data for weapon #{human_readable[name]}"

  weapon_table_url = "https://mhgu.kiranico.com/#{name}"
  weapon_table_doc = Nokogiri::HTML(open(weapon_table_url))
  table_rows = weapon_table_doc.css('#list td[rowspan]')

  # Collect the first url for every set of weapons,
  # It is easier to collect the individual weapon data from the first weapon in
  # a set than to collect it from each weapon table.
  #
  # e.g. For GreatSword:
  # Petrified Blade: https://mhgu.kiranico.com/weapon/34ed4
  # Iron Sword: ...
  # Massacre Blade: ..
  weapon_set_urls = table_rows.map { |e| e.css('div').first.css('a').first[:href] }
  puts "Found #{weapon_set_urls.length} #{human_readable[name]} weapon sets"
  weapon_set_urls.each do |url|
    doc = Nokogiri::HTML(open(url))
    table = doc.search('/html/body/div[1]/div[2]/div[1]/div[2]/div[2]/div/div[3]/div/div/table')
    table.css("tr").each do |weapon_row|
      columns = weapon_row.css("td")
      weapon_name = columns[0].text
      damage = columns[1].text.to_i

      # Column 2 has affinity and elemental info. gotta wait on that for now
      # Also skipping sharpness cause it's gonna be a funky ride
      # sharpness = columns[3]

      # I don't think think is a standard ASCII character.
      slots = columns[4].count('â—¯')
      rarity = columns[5].text.strip.split[-1].to_i
      binding.pry
    end
  end

  # For each weapon set, navigate to the link and collect all the relevant data for
  # every weapon on the page.
  # e.g. Navigate to https://mhgu.kiranico.com/weapon/34ed4
  # Get the data for Petrified Blade LV1 - LV7, Scholarly Blade LV8-LV10, Sophos Blade LV11
  # TODO: Implement this shit
end
